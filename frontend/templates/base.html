<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Inventory Management</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
</head>
<body class="p-4">
  <nav class="mb-4">
    <!-- Guest-only links -->
    <a href="{% url 'signup' %}" id="signup-btn" class="btn btn-primary">Signup</a>
    <a href="{% url 'login' %}" id="login-btn" class="btn btn-secondary">Login</a>

    <!-- Auth-only links -->
    <a href="{% url 'items' %}" id="items-btn" class="btn btn-success d-none">Items</a>
    <a href="{% url 'reports' %}" id="reports-btn" class="btn btn-info d-none">Reports</a>
    <button id="logout-btn" class="btn btn-danger d-none">Logout</button>
  </nav>

  <div class="container">
    {% block content %}{% endblock %}
  </div>

  <script>
    function parseJwt(token) {
      try {
        const base64Url = token.split('.')[1];
        const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
        return JSON.parse(atob(base64));
      } catch (e) {
        return null;
      }
    }

    function checkAuth() {
      const token = localStorage.getItem("access");
      const signupBtn = document.getElementById("signup-btn");
      const loginBtn = document.getElementById("login-btn");
      const itemsBtn = document.getElementById("items-btn");
      const reportsBtn = document.getElementById("reports-btn");
      const logoutBtn = document.getElementById("logout-btn");

      const path = window.location.href;
      const page = path.split('/').filter(item => item.length > 0).at(-1);

      let valid = false;
      if (token) {
        const payload = parseJwt(token);
        if (payload && payload.exp * 1000 > Date.now()) {
          valid = true;
        }
      }

      if (valid) {
        signupBtn.classList.add("d-none");
        loginBtn.classList.add("d-none");

        // if(path == '')
        itemsBtn.classList.remove("d-none");
        reportsBtn.classList.remove("d-none");
        logoutBtn.classList.remove("d-none");
    } else {
          console.log(page)
          if(page == 'login'){
              signupBtn.classList.remove("d-none");
              loginBtn.classList.add("d-none");
          } else{
              loginBtn.classList.remove("d-none");
              signupBtn.classList.add("d-none");
          }
        itemsBtn.classList.add("d-none");
        reportsBtn.classList.add("d-none");
        logoutBtn.classList.add("d-none");
      }
    }



    document.getElementById("logout-btn").addEventListener("click", function() {
      localStorage.removeItem("access");
      localStorage.removeItem("refresh");
      checkAuth();
      window.location.href ='/login'
    });

    // Run on load
    checkAuth();
  </script>
</body>
</html>
