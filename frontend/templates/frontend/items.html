{% extends "base.html" %}
{% block content %}
<h2 class="mb-3">Inventory Items</h2>

<div class="card p-3 mb-4">
  <h5>Add New Item</h5>
  <form id="itemForm" class="row g-2">
    <div class="col-md-3">
      <input class="form-control" placeholder="Name" name="name" required>
    </div>
    <div class="col-md-3">
      <input class="form-control" placeholder="Description" name="description">
    </div>
    <div class="col-md-2">
      <input class="form-control" type="number" placeholder="Quantity" name="quantity" required>
    </div>
    <div class="col-md-2">
      <input class="form-control" type="number" step="0.01" placeholder="Price" name="price" required>
    </div>
    <div class="col-md-2">
      <input class="form-control" type="number" placeholder="Category ID" name="category" required>
    </div>
    <div class="col-12">
      <button class="btn btn-success mt-2">Add Item</button>
    </div>
  </form>
</div>

<div class="card p-3">
  <h5>Items List</h5>
  <table class="table table-striped table-bordered mt-2">
    <thead class="table-dark">
      <tr>
        <th>ID</th>
        <th>Name</th>
        <th>Description</th>
        <th>Quantity</th>
        <th>Price</th>
        <th>Category</th>
      </tr>
    </thead>
    <tbody id="itemsTable"></tbody>
  </table>
</div>

<script>
const token = localStorage.getItem("access");

// Refresh access token using refresh token
async function refreshAccessToken(fn) {
  const tokens = getTokens();
  if (!tokens.refresh) {
    console.warn("No refresh token available.");
    return null;
  }

  const res = await fetch(`/auth/token/refresh/`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ refresh: tokens.refresh }),
  });

  if (res.ok) {
    const data = await res.json();
    saveTokens(data.access, tokens.refresh);  // keep refresh, update access
    return data.access;
  } else {
    console.error("Refresh failed, need to login again.");
    localStorage.clear();
    window.location.href = "/login";  // redirect to login page
    return null;
  }
}

async function loadItems() {
  const token = localStorage.getItem("access"); // make sure token exists
  const res = await fetch("/api/inventory/items/", {
    headers: { "Authorization": "Bearer " + token }
  });

  const data = await res.json();
  console.log("Fetched items:", data); // debug

  // use data.results since it's paginated
  document.getElementById("itemsTable").innerHTML =
    data.results.map(i => `
      <tr>
        <td>${i.id}</td>
        <td>${i.name}</td>
        <td>${i.description || "-"}</td>
        <td>${i.quantity}</td>
        <td>$${i.price}</td>
        <td>${i.category_name}</td>
      </tr>
    `).join("");
}


document.getElementById("itemForm").onsubmit = async (e) => {
    e.preventDefault();
    const formData = Object.fromEntries(new FormData(e.target).entries());
    await fetch("/api/inventory/items/", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "Authorization": "Bearer " + token
        },
        body: JSON.stringify(formData)
  });
  e.target.reset();
  loadItems();
};

document.addEventListener("DOMContentLoaded", loadItems);
// loadItems();
</script>
{% endblock %}
